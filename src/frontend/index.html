<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logistics Watchtower</title>
    <meta name="description" content="Real-time cold chain fleet monitoring dashboard">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           DESIGN TOKENS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-card-hover: #334155;
            --border: #334155;

            --text: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;

            --accent: #0ea5e9;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;

            --radius: 12px;
            --sidebar-w: 320px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RESET & BASE
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            overflow: hidden;
            font-size: 14px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LAYOUT
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .app {
            display: grid;
            grid-template-columns: var(--sidebar-w) 1fr;
            height: 100vh;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SIDEBAR
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .sidebar {
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            /* background: linear-gradient(135deg, var(--accent), #6366f1); */
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .logo h1 {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .logo span {
            font-size: 11px;
            color: var(--text-muted);
            display: block;
            margin-top: 2px;
        }

        /* Status Badge */
        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: var(--bg-dark);
            border-radius: 8px;
            font-size: 13px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-dot.online {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
            animation: pulse 2s infinite;
        }

        .status-dot.offline {
            background: var(--danger);
        }

        @keyframes pulse {
            50% {
                opacity: 0.5;
            }
        }

        .live-tag {
            margin-left: auto;
            padding: 2px 8px;
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
            font-size: 10px;
            font-weight: 600;
            border-radius: 4px;
            text-transform: uppercase;
        }

        /* Metrics */
        .metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .metric {
            text-align: center;
            padding: 12px 8px;
            background: var(--bg-dark);
            border-radius: 8px;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent);
        }

        .metric.danger .metric-value {
            color: var(--danger);
        }

        .metric.warning .metric-value {
            color: var(--warning);
        }

        .metric-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* Fleet List */
        .fleet-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 16px 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .count-badge {
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--bg-dark);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .fleet-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .fleet-list::-webkit-scrollbar {
            width: 4px;
        }

        .fleet-list::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        /* Truck Card */
        .truck-card {
            display: grid;
            grid-template-columns: 36px 1fr auto;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-dark);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .truck-card:hover {
            background: var(--bg-card-hover);
        }

        .truck-card.alert {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .truck-icon {
            width: 36px;
            height: 36px;
            background: var(--bg-card);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .truck-info h3 {
            font-size: 13px;
            font-weight: 600;
        }

        .truck-meta {
            display: flex;
            gap: 10px;
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .truck-meta span {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .truck-status {
            font-size: 10px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .truck-status.ok {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .truck-status.alert {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        /* Footer */
        .footer {
            padding: 12px 20px;
            border-top: 1px solid var(--border);
            font-size: 11px;
            color: var(--text-muted);
            text-align: center;
        }

        .footer span {
            color: var(--accent);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MAP
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .map-container {
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 1000;
        }

        .map-btn {
            width: 40px;
            height: 40px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .map-btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TOAST NOTIFICATIONS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .toast-container {
            position: fixed;
            top: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 2000;
            max-width: 360px;
        }

        .toast {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px 16px;
            background: var(--bg-card);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast-icon {
            width: 32px;
            height: 32px;
            background: rgba(239, 68, 68, 0.15);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
            min-width: 0;
        }

        .toast-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--danger);
        }

        .toast-message {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MAP MARKERS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .marker {
            width: 14px;
            height: 14px;
            background: var(--accent);
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.4);
        }

        .marker.alert {
            width: 18px;
            height: 18px;
            background: var(--danger);
            box-shadow: 0 0 16px var(--danger);
            animation: alertPulse 1s infinite;
        }

        @keyframes alertPulse {
            50% {
                transform: scale(1.2);
            }
        }

        /* Leaflet Popup */
        .leaflet-popup-content-wrapper {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .leaflet-popup-content {
            margin: 12px 14px;
            font-family: 'Inter', sans-serif;
            color: var(--text);
        }

        .leaflet-popup-tip {
            background: var(--bg-card);
        }

        .popup {
            min-width: 200px;
        }

        .popup-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 10px;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .popup-header .icon {
            font-size: 18px;
        }

        .popup-header .title {
            font-weight: 600;
            font-size: 14px;
        }

        .popup-header .severity {
            margin-left: auto;
            font-size: 9px;
            font-weight: 700;
            padding: 3px 6px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .severity.critical {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .severity.high {
            background: rgba(249, 115, 22, 0.2);
            color: #f97316;
        }

        .severity.medium {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .popup-alert {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            font-size: 11px;
            font-weight: 500;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .popup-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .popup-item {
            display: flex;
            flex-direction: column;
        }

        .popup-item .label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .popup-item .value {
            font-size: 13px;
            font-weight: 500;
        }

        .popup-item .value.danger {
            color: var(--danger);
        }

        .popup-item .value.warning {
            color: var(--warning);
        }

        /* Hide default Leaflet zoom */
        .leaflet-control-zoom {
            display: none;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LOADING
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .loading {
            position: fixed;
            inset: 0;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.4s;
        }

        .loading.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading p {
            margin-top: 16px;
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RESPONSIVE
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @media (max-width: 768px) {
            .app {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
                z-index: 1001;
                transition: transform 0.3s;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .mobile-toggle {
                display: flex;
            }
        }

        .mobile-toggle {
            display: none;
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 1002;
            width: 44px;
            height: 44px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            align-items: center;
            justify-content: center;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Connecting to fleet...</p>
    </div>

    <!-- Toasts -->
    <div class="toast-container" id="toasts"></div>

    <!-- Mobile Toggle -->
    <button class="mobile-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')">â˜°</button>

    <!-- App -->
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <header class="header">
                <div class="logo">
                    <div class="logo-icon">ğŸš›</div>
                    <div>
                        <h1>Watchtower</h1>
                        <span>Fleet Command Center</span>
                    </div>
                </div>
                <div class="status-badge">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Connecting...</span>
                    <span class="live-tag" id="liveTag" style="display:none">Live</span>
                </div>
            </header>

            <div class="metrics">
                <div class="metric">
                    <div class="metric-value" id="metricActive">0</div>
                    <div class="metric-label">Active</div>
                </div>
                <div class="metric danger">
                    <div class="metric-value" id="metricAlerts">0</div>
                    <div class="metric-label">Alerts</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="metricTemp">--</div>
                    <div class="metric-label">Avg Â°C</div>
                </div>
                <div class="metric warning">
                    <div class="metric-value" id="metricFuel">--</div>
                    <div class="metric-label">Low Fuel</div>
                </div>
            </div>

            <section class="fleet-section">
                <div class="section-header">
                    <span class="section-title">Fleet</span>
                    <span class="count-badge" id="fleetCount">0 trucks</span>
                </div>
                <div class="fleet-list" id="fleetList"></div>
            </section>

            <footer class="footer">
                Streaming from <span>Redpanda</span> â€¢ v2.0
            </footer>
        </aside>

        <!-- Map -->
        <main class="map-container">
            <div id="map"></div>
            <div class="map-controls">
                <button class="map-btn" onclick="map.zoomIn()" title="Zoom in">+</button>
                <button class="map-btn" onclick="map.zoomOut()" title="Zoom out">âˆ’</button>
                <button class="map-btn" onclick="map.setView([7.5, 6], 6)" title="Reset">âŒ‚</button>
            </div>
        </main>
    </div>

    <!-- Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // STATE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const state = {
            trucks: {},
            markers: {},
            alerts: new Set(),
            temps: [],
            lowFuel: 0
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MAP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const map = L.map('map', { zoomControl: false }).setView([7.5, 6], 6);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: 'Â©OpenStreetMap Â©CartoDB'
        }).addTo(map);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // HELPERS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const $ = id => document.getElementById(id);

        function createMarkerIcon(isAlert) {
            return L.divIcon({
                className: '',
                html: `<div class="marker ${isAlert ? 'alert' : ''}"></div>`,
                iconSize: [18, 18],
                iconAnchor: [9, 9]
            });
        }

        function showToast(title, message, id) {
            const container = $('toasts');
            const existing = container.querySelector(`[data-id="${id}"]`);
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.dataset.id = id;
            toast.innerHTML = `
                <div class="toast-icon">ğŸš¨</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 6000);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UI UPDATES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function updateMetrics() {
            const count = Object.keys(state.trucks).length;
            const avgTemp = state.temps.length
                ? Math.round(state.temps.reduce((a, b) => a + b) / state.temps.length)
                : '--';

            $('metricActive').textContent = count;
            $('metricAlerts').textContent = state.alerts.size;
            $('metricTemp').textContent = avgTemp;
            $('metricFuel').textContent = state.lowFuel;
            $('fleetCount').textContent = `${count} truck${count !== 1 ? 's' : ''}`;
        }

        function updateTruckCard(id, data, isAlert) {
            let card = $(`truck-${id}`);
            const temp = data.temperature_c ?? data.temperature ?? '--';
            const speed = data.speed_kmh ?? 0;
            const fuel = data.fuel_level_pct ?? 100;

            if (!card) {
                card = document.createElement('div');
                card.id = `truck-${id}`;
                card.className = 'truck-card';
                card.onclick = () => {
                    const m = state.markers[id];
                    if (m) { map.setView(m.getLatLng(), 10); m.openPopup(); }
                };
                $('fleetList').appendChild(card);
            }

            card.className = `truck-card ${isAlert ? 'alert' : ''}`;
            card.innerHTML = `
                <div class="truck-icon">${isAlert ? 'âš ï¸' : 'ğŸš›'}</div>
                <div class="truck-info">
                    <h3>${id}</h3>
                    <div class="truck-meta">
                        <span>ğŸŒ¡ï¸ ${typeof temp === 'number' ? temp.toFixed(1) : temp}Â°C</span>
                        <span>ğŸš— ${speed.toFixed(0)} km/h</span>
                        <span>â›½ ${fuel.toFixed(0)}%</span>
                    </div>
                </div>
                <div class="truck-status ${isAlert ? 'alert' : 'ok'}">${isAlert ? 'Alert' : 'OK'}</div>
            `;

            // Move alerts to top
            if (isAlert) $('fleetList').prepend(card);
        }

        function createPopup(id, data, isAlert) {
            const temp = data.temperature_c ?? data.temperature ?? '--';
            const speed = data.speed_kmh ?? '--';
            const fuel = data.fuel_level_pct ?? '--';
            const status = (data.status ?? 'UNKNOWN').replace(/_/g, ' ');
            const severity = data.severity ?? '';
            const alertType = data.alert_type ?? '';

            return `
                <div class="popup">
                    <div class="popup-header">
                        <span class="icon">${isAlert ? 'ğŸš¨' : 'ğŸš›'}</span>
                        <span class="title">${id}</span>
                        ${severity ? `<span class="severity ${severity.toLowerCase()}">${severity}</span>` : ''}
                    </div>
                    ${isAlert ? `<div class="popup-alert">${alertType}: ${data.alert_message || 'Alert'}</div>` : ''}
                    <div class="popup-grid">
                        <div class="popup-item">
                            <span class="label">Status</span>
                            <span class="value">${status}</span>
                        </div>
                        <div class="popup-item">
                            <span class="label">Temperature</span>
                            <span class="value ${temp > -5 ? 'danger' : ''}">${typeof temp === 'number' ? temp.toFixed(1) : temp}Â°C</span>
                        </div>
                        <div class="popup-item">
                            <span class="label">Speed</span>
                            <span class="value">${typeof speed === 'number' ? speed.toFixed(0) : speed} km/h</span>
                        </div>
                        <div class="popup-item">
                            <span class="label">Fuel</span>
                            <span class="value ${fuel < 15 ? 'warning' : ''}">${typeof fuel === 'number' ? fuel.toFixed(0) : fuel}%</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function setOnline(online) {
            $('statusDot').className = `status-dot ${online ? 'online' : 'offline'}`;
            $('statusText').textContent = online ? 'Connected' : 'Disconnected';
            $('liveTag').style.display = online ? '' : 'none';
            if (online) setTimeout(() => $('loading').classList.add('hidden'), 300);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // WEBSOCKET
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function connect() {
            const ws = new WebSocket('ws://localhost:8000/ws');

            ws.onopen = () => setOnline(true);
            ws.onclose = () => { setOnline(false); setTimeout(connect, 3000); };
            ws.onerror = () => setOnline(false);

            ws.onmessage = e => {
                const data = JSON.parse(e.data);
                const id = data.truck_id;
                const isAlert = data.topic === 'alerts';

                // Update state
                state.trucks[id] = data;

                // Track temps
                const temp = data.temperature_c ?? data.temperature;
                if (temp !== undefined) {
                    state.temps.push(temp);
                    if (state.temps.length > 50) state.temps.shift();
                }

                // Track alerts
                if (isAlert) state.alerts.add(id);
                else state.alerts.delete(id);

                // Track low fuel
                const fuel = data.fuel_level_pct ?? 100;
                state.lowFuel = Object.values(state.trucks).filter(t => (t.fuel_level_pct ?? 100) < 15).length;

                // Marker
                if (!state.markers[id]) {
                    state.markers[id] = L.marker([data.latitude, data.longitude], {
                        icon: createMarkerIcon(isAlert)
                    }).addTo(map);
                }

                const marker = state.markers[id];
                marker.setLatLng([data.latitude, data.longitude]);
                marker.setIcon(createMarkerIcon(isAlert));
                marker.bindPopup(createPopup(id, data, isAlert));

                // Toast for alerts
                if (isAlert) {
                    showToast(`Alert: ${id}`, data.alert_message || data.alert_type, id);
                    marker.openPopup();
                }

                // UI
                updateTruckCard(id, data, isAlert);
                updateMetrics();
            };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INIT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        connect();
    </script>
</body>

</html>